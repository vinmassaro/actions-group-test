name: Matrix Extended Simple Demo (fixed)

on:
  workflow_dispatch:

jobs:
  matrix-builder:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.extend.outputs.matrix }}
    steps:
      - name: Generate sites.json
        run: |
          set -euo pipefail
          TOTAL=300
          echo '{"include":[' > sites.json
          first=true
          for i in $(seq 1 "$TOTAL"); do
            if [ "$first" = true ]; then
              first=false
            else
              printf ',' >> sites.json
            fi
            printf '{"site":"site-%s"}' "$i" >> sites.json
          done
          echo ']}' >> sites.json
          echo "Generated sites.json:"
          cat sites.json

      - id: extend
        name: Run matrix-extended
        uses: cloudposse/github-action-matrix-extended@main
        with:
          matrix: ./sites.json
          nested-matrices-count: "2"

  run-groups:
    needs: matrix-builder
    strategy:
      # Use the full object returned by matrix-extended (contains an "include" array)
      matrix: ${{ fromJson(needs.matrix-builder.outputs.matrix) }}
      max-parallel: 1
    runs-on: ubuntu-latest
    steps:
      - name: Show group info
        run: |
          echo "matrix.name = ${{ matrix.name }}"
          # matrix.items may be a JSON array or a JSON string; write it to a file safely.
          echo "${{ matrix.items }}" > items.json
          echo "items.json content:"
          cat items.json

      - name: Parse and run demo deploys for group sites
        run: |
          set -euo pipefail
          # Safely parse items.json: if it's a string -> fromjson, else use as-is.
          # Then iterate .[].site
          jq -r 'if type=="string" then fromjson else . end | .[]?.site' items.json | while read -r site; do
            echo "---- Deploying $site ----"
            echo "Step: check"
            sleep 0.03
            echo "Step: migrate"
            sleep 0.03
            echo "Step: finalize"
          done
