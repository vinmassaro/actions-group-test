name: Matrix Extended Demo (300 sites)

on:
  workflow_dispatch:

jobs:
  matrix-builder:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.extend.outputs.matrix }}
    steps:
      - name: Generate 300-site matrix.json
        run: |
          # generate JSON with include array
          echo '{"include":[' > matrix.json
          for i in $(seq 1 300); do
            printf '{"site":"site-%d"}' "$i" >> matrix.json
            if [ $i -lt 300 ]; then echo "," >> matrix.json; fi
          done
          echo "]}" >> matrix.json
          cat matrix.json

      - id: extend
        uses: cloudposse/github-action-matrix-extended@main
        with:
          matrix: ./matrix.json
          nested-matrices-count: '2'  # split into 2-level matrix to bypass 256 limit

  run-matrix:
    needs: matrix-builder
    strategy:
      max-parallel: 1           # controls how many outer groups run at once
      matrix: ${{ fromJson(needs.matrix-builder.outputs.matrix) }}
    uses: ./.github/workflows/matrix-extended-300-inner.yml
    with:
      items: ${{ toJson(matrix.items }}   # <-- pass JSON, not string
