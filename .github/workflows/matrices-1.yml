name: matrices-1

on:
  workflow_dispatch:

jobs:
  matrix-builder:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.extend.outputs.matrix }}
    steps:
      - name: Generate 300-site matrix.json (bash only)
        run: |
          set -euo pipefail
          out=matrix.json
          echo '{"include":[' > "$out"
          first=true
          for i in $(seq 1 300); do
            if [ "$first" = true ]; then
              first=false
            else
              printf ',' >> "$out"
            fi
            printf '{"site":"site-%d"}' "$i" >> "$out"
          done
          echo ']}' >> "$out"
          echo "Wrote $out:"
          cat "$out"

      - id: extend
        name: Extend matrix (cloudposse matrix-extended)
        uses: cloudposse/github-action-matrix-extended@main
        with:
          matrix: ./matrix.json
          nested-matrices-count: '2'

  run-matrix:
    needs: matrix-builder
    # Control how many outer groups run in parallel. Keep small to avoid API/runners flood.
    strategy:
      max-parallel: 1
      matrix: ${{ fromJson(needs.matrix-builder.outputs.matrix) }}
    # Call the reusable workflow file (local)
    uses: ./.github/workflows/matrices-2.yml
    with:
      # Pass JSON (not a quoted string). Note the balanced parentheses.
      items: ${{ toJson(matrix.items) }}
