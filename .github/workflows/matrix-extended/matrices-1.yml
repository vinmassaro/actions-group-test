name: Matrix Extended Demo (300 sites)

on:
  workflow_dispatch:

jobs:
  matrix-builder:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.extend.outputs.matrix }}
    steps:
      - name: Generate 300-site matrix.json
        run: |
          python - <<'PY' > matrix.json
          import json
          items=[{"site":f"site-{i}"} for i in range(1,301)]
          print(json.dumps({"include": items}))
          PY
          echo "Wrote matrix.json with 300 sites"

      - name: Extend matrix (matrix-extended)
        id: extend
        uses: cloudposse/github-action-matrix-extended@main
        with:
          # pass file path (or could pass the JSON string)
          matrix: ./matrix.json
          # use 2 nested levels: outer groups + inner items
          nested-matrices-count: '2'
          # optional helpers (not required)
          sort-by: '.[].site'
          group-by: '.site'
  # call the reusable workflow for each group produced by matrix-extended
  operation:
    needs: matrix-builder
    if: ${{ needs.matrix-builder.outputs.matrix != '{"include":[]}' }}
    # Use a small parallelism so outer-level doesn't flood API; each matrix entry will be a "group"
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix-builder.outputs.matrix) }}
    uses: ./.github/workflows/matrices-2.yml
    with:
      items: ${{ matrix.items }}
